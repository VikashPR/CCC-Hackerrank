name: Update Visitors Badge
on:
  schedule:
    - cron: '0 * * * *' # Run every hour
  workflow_dispatch:

jobs:
  update-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Update Visitors Badge
        uses: actions/github-script@v4
        with:
          script: |
            const fs = require('fs');
            const fetch = require('node-fetch');
            const { createBadge } = require('badge-maker');

            const response = await fetch('https://api.github.com/repos/VikashPR/CCC-Hackerrank/traffic/views', {
              headers: {
                'Authorization': `token ${{ secrets.GITHUB_TOKEN }}`
              }
            });

            if (!response.ok) {
              throw new Error(`HTTP error ${response.status} (${response.statusText})`);
            }

            const data = await response.json();
            const visitors = data.count;

            const readme = fs.readFileSync('README.md', 'utf8');

            const badge = createBadge({
              text: ['Visitors', visitors.toLocaleString()],
              colorscheme: 'blue',
              template: 'for-the-badge'
            });

            const newReadme = readme.replace(/!\[Visitors\]\([^)]+\)/, badge);

            fs.writeFileSync('README.md', newReadme);
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
